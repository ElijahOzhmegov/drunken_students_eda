---
title: "EDA of Alcohol Consumption among Students"
author: Ilia Ozhmegov, Olena Horyn
date: "`r format(Sys.time(), '%B %Y')`"
output: 
  html_document:
    df_print: paged
    highlight: pygments
    fontsize: 11pt
    number_section: true
    toc_depth: 2
    toc_float: true
    toc: yes
    fig_caption: true
    theme: cosmo
  pdf_document:
    latex_engine: xelatex
    df_print: kable
    highlight: pygments
    number_section: true
    toc: yes
    fig_caption: true
---

```{r Setting template options, include=FALSE}

# knitr::opts_chunk$set(message=TRUE, warning = TRUE, echo = TRUE)
knitr::opts_chunk$set(message=FALSE, warning = FALSE, echo = TRUE)
knitr::opts_chunk$set(fig.show = "hold", fig.align = "center")

```


```{r Loading libraries, include=FALSE}

source("common/load_data.R")
source("common/load_functions.R")
# df <- readRDS("data/student-full.rds")
```

The data were obtained in a survey of students math and Portuguese language courses in secondary school. It contains a lot of interesting social, gender and study information about students.

# Student Data

In Portugal, the secondary education consists of 3 years of schooling, preceding 
9 years of basic education and followed by higher education. Most of the students join the public and free education system. There are several
courses (e.g. Sciences and Technologies, Visual Arts)
that share core subjects such as the Portuguese Language and Mathematics. Like several other countries
(e.g. France or Venezuela), a 20-point grading scale is
used, where 0 is the lowest grade and 20 is the perfect
score. During the school year, students are evaluated
in three periods and the last evaluation (G3 of Table 1)
corresponds to the final grade.

This study will consider data collected during the 2005-
2006 school year from two public schools, from the Alentejo region of Portugal. Although there has been a trend
for an increase of Information Technology investment
from the Government, the majority of the Portuguese
public school information systems are very poor, relying mostly on paper sheets (which was the current case).
Hence, the database was built from two sources: school
reports, based on paper sheets and including few attributes (i.e. the three period grades and number of
school absences); and questionnaires, used to complement the previous information. Original researches designed the latter
with closed questions (i.e. with predefined options) related to several demographic (e.g. mother’s education,
family income), social/emotional (e.g. alcohol consumption) (Pritchard and Wilson 2003) and school related
(e.g. number of past class failures) variables that were
expected to affect student performance. The questionnaire was reviewed by school professionals and tested on
a small set of 15 students in order to get a feedback. The
final version contained 37 questions in a single A4 sheet
and it was answered in class by 788 students. Latter,
111 answers were discarded due to lack of identification
details (necessary for merging with the school reports).
Finally, the data was integrated into two datasets related to Mathematics (with 395 examples) and the Portuguese language (649 records) classes.

During the original preprocessing stage, some features were discarded due to the lack of discriminative value. For instance, few respondents answered about their family
income (probably due to privacy issues), while almost
100% of the students live with their parents and have a
personal computer at home. The remaining attributes
are shown in Table 1, where the last four rows denote
the variables taken from the school reports.

```{r table-simple, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
require(pander)
panderOptions('table.split.table', Inf)
panderOptions('table.alignment.default', 'left')
set.caption("Table 1: data after all the preprocessing stages")
my.data <- "
Attribute | Description | Domain
school | student's school | binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira
gender | student's gender | binary: 'F' - female or 'M' - male
age | student's age | numeric: from 15 to 22
address | student's home address type | binary: 'U' - urban or 'R' - rural
famsize | family size | binary: 'LE3' - less or equal to 3 or 'GT3' - greater than 3
Pstatus | parent's cohabitation status | binary: 'T' - living together or 'A' - apart
Medu | mother's education | numeric: 0 - none, 1 - primary education (4th grade, 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education)
Fedu | father's education | numeric: 0 - none, 1 - primary education (4th grade, 2 – 5th to 9th grade, 3 – secondary education or 4 – higher education)
Mjob | mother's job | nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police, 'at_home' or 'other')
Fjob | father's job | nominal: 'teacher', 'health' care related, civil 'services' (e.g. administrative or police, 'at_home' or 'other')
reason | reason to choose this school | nominal: close to 'home', school 'reputation', 'course' preference or 'other'
guardian | student's guardian | nominal: 'mother', 'father' or 'other'
traveltime | home to school travel time | numeric: 1 - 1 hour
studytime | weekly study time | numeric: 1 - 10 hours
failures | number of past class failures | numeric: n if 1<=n<3, else 4
schoolsup | extra educational support | binary: yes or no
famsup | family educational support | binary: yes or no
subject* | taken course subject | nominal: Math or Portuguese
paid | extra paid classes within the course subject | Math or Portuguese (binary: yes or no)
activities | extra-curricular activities | binary: yes or no
nursery | attended nursery school | binary: yes or no
higher | wants to take higher education | binary: yes or no
internet | Internet access at home | binary: yes or no
romantic | with a romantic relationship | binary: yes or no
famrel | quality of family relationships | numeric: from 1 - very bad to 5 - excellent
freetime | free time after school | numeric: from 1 - very low to 5 - very high
goout | going out with friends | numeric: from 1 - very low to 5 - very high
Dalc | workday alcohol consumption | numeric: from 1 - very low to 5 - very high
Walc | weekend alcohol consumption | numeric: from 1 - very low to 5 - very high
Salc* | sum of alcohol consumption | numeric: from 2 - extremely low to 5 - extremely high
health | current health status | numeric: from 1 - very bad to 5 - very good
absences | number of school absences | numeric: from 0 to 93
G1 | first period grade | numeric: from 0 to 20
G2 | second period grade | numeric: from 0 to 20
G3 | final grade | numeric: from 0 to 20, output target
G3_d* | final grade | nominal: from A to F, output target*
"
df <- read.delim(textConnection(my.data),header=FALSE,sep="|",strip.white=TRUE,stringsAsFactors=FALSE)
names(df) <- unname(as.list(df[1,])) # put headers on
df <- df[-1,] # remove first row
row.names(df)<-NULL
pander(df, style = 'rmarkdown')
```

The labeled with `*` attributes were added during the current research.

# Main Goals

* to find what affects on success the most significantly
* to find what affects on alcohol consumption the most significantly


# Brief introduction into alcohol consumption

Let us have a look at alcohol consumption and compare it during weekday and weekend.

```{r, fig.cap = "Figure 1: foobar"}
  reshape2::melt(full_df[,c('Dalc','Walc')],id.vars = 0) %>% 
    group_by(variable, value) %>% 
    summarise(n=n()) %>% 
    mutate(
      value = factor(value, levels = c("Very Low", "Low", "Medium", "High", "Very High")) 
    ) %>% 
    ggplot(aes(x=value, y=n)) +
    geom_bar(aes(fill = variable),stat = "identity", position = "dodge") +
    theme_bw() +
    scale_fill_manual(values = matlab.colors[1:2],
                      name   = "Weektype", 
                      labels = c("Weekday", "Weekend")) +
    theme(legend.position = c(0.85, 0.85), legend.box = "vertical") +
    labs(y = "Number of students", 
         x = "Alcohol consumption", 
         title = "Comparison alcohol consumption during weekend and weekday")

```
The result is clear, during weekend consumption is higher than during weekdays.

# What affects the most on success

Though basically we have categorical data we still want to have a look at
correlation between final grade and all others variables

```{r}

{ 
  int_df <- lapply(full_df, as.integer)
  n = length(int_df)
  
  c = rep(0, n)
  for(i in 1:n) c[i] = cor(int_df$G3, int_df[[i]]) %>% abs()

  data.frame(correlation = c, name = colnames(full_df))  %>% 
    filter(!str_detect(name, "^G")) %>% 
    ggplot(aes(x = correlation, y = reorder(name, correlation))) + 
    geom_bar(stat = "identity", aes(fill = str_detect(name, "alc$"))) +
    scale_fill_manual(values = matlab.colors[1:2]) +
    theme_bw() +
    theme(legend.position="none") +
    labs(y = "Variable", x = "|Correlation|", title = "Final Grade Correlation")
  
}

```

Result: in general there is a poor dependence between variables and 
final grade, but it is important to remind that all variable are categorical, 
but `failures` and `absences` (`failures` is not fully continuous). Also, 
we highlighted the alcohol consumption variables to show that there is 
no clear linear dependence. 
  

## Closer look at dependence between Grades and alcohol consumption

Simple presentation of grades before diving deeper to show the quantity of
the students divided into different success groups.

We will consider as successful only students with grades from "C" to "A" and 
as unsuccessful with grades "F" and "D". As Portuguese educational system uses 
numeric marks from 0 to 20, we need to transform it into  the five-level 
classification system.

| Original | 5-level |
| :----: | :-----: |
| [16,20] | A |
| [14,16) | B |
| [12,14) | C |
| [10,12) | D |
| [0, 10) | F |

```{r}
{  ddf <- full_df %>% 
    mutate(
      success = ifelse(G3_d == 'F' | G3_d == 'D', 'No', 'Yes'),
      G3_d = factor(G3_d, levels = c('F', 'D', 'C', 'B', 'A'))
      )  
    
  p1 <- ddf %>% 
    ggplot(aes(x=G3_d, fill=success)) +
    geom_bar(position = "dodge") +
    theme_bw() +
    theme(legend.position="none") +
    scale_fill_manual(values=matlab.colors[2:1]) +
    labs(y = "Number of students", 
         x = "Final Grade (Descrete)", 
         title = "Final Grade Descrete Distribution")
    
  p2 <- ddf %>% 
    ggplot(aes(x=success, fill=success)) +
    geom_bar(position = "dodge") +
    scale_fill_manual(values=matlab.colors[2:1]) +
    theme_bw() +
    scale_x_discrete(breaks=c("No","Yes"),
                     labels=c("Low", "High")) +
    labs(y = "Number of students", 
         x = "Final Grade (Binary)", 
         title = "Final Grade Binary Distribution")
  
  grid.arrange(p1, p2, nrow=1)
  
  
}
```
As you can seen the amount of students in both groups is almost the same.


Let us have a look directly at dependence between Grades and Alcohol consumption.

```{r}
{

  class_df = full_df %>% 
    mutate(
      s_class = ifelse(G3 < 12, 1, 2),
      s_class = s_class + ifelse(as.numeric(Salc) < 5, 0, 2),
      G3_d = factor(G3_d, levels = c('F', 'D', 'C', 'B', 'A'))
      ) 
  
  class_df %>% 
    ggplot(aes(x=Salc, G3_d)) +
    geom_jitter(aes(colour = as.factor(s_class))) + 
    scale_color_manual(values=matlab.colors[c(2, 3, 4, 1)]) +
    theme_bw() +
    theme(legend.position="none") +
    labs(y = "Final Grade (Descrete)", 
         x = "Alcohol consumption", 
         title = "Final period grade")
  
}
```
Result: decent grades are much less frequent among high alcohol consumption Students, 
also there is no dependence between low alcohol consumption and decent grades. The last 
point can be seen more vividly in the following figure.
  
```{r}
  class_df %>% 
    mutate(
      failure   = ifelse( s_class %% 2 == 1, 'High', 'Low'),
      addiction = ifelse( s_class > 3, 'High', 'Low'),
      failure   = factor(failure,   levels = c('Low', 'High')),
      addiction = factor(addiction, levels = c('Low', 'High'))
    ) %>% 
    ggplot() +
    geom_mosaic(aes(x=product(failure, addiction), fill=failure), na.rm = TRUE) +
    scale_fill_manual(values=matlab.colors[2:1]) +
    theme_bw() +
    theme(legend.position="none") +
    labs(x = "The amount of alcohol consumption",
         y = "Final Grade (Binary)",
         title = "Final period grade")

```

Result: you can clearly see that among low alcohol consumption students the amount of 
successful students is approximately the same as less successful students.

## Dependence between Grades and such variables as gender and age

How does age and gender affect on success?

```{r}
{
  
  age_min = (full_df$age - 0.5) %>% min() %>% as.factor()
  age_max = (full_df$age + 0.5) %>% max() %>% as.factor()
  
  common_alpha = 0.4
  
  full_df %>% 
    ggplot() +
    annotate("rect",
             xmin = age_min, xmax = age_max,
             ymin = 0,  ymax = 10, fill = colours_5[[5]],
             alpha = common_alpha
    ) +
    annotate("rect",
             xmin = age_min, xmax = age_max,
             ymin = 10, ymax = 12, fill = colours_5[[4]],
             alpha = common_alpha
    ) +
    annotate("rect",
             xmin = age_min, xmax = age_max,
             ymin = 12, ymax = 14, fill = colours_5[[3]],
             alpha = common_alpha
    ) +
    annotate("rect",
             xmin = age_min, xmax = age_max,
             ymin = 14, ymax = 16, fill = colours_5[[2]],
             alpha = common_alpha
    ) +
    annotate("rect",
             xmin = age_min, xmax = age_max,
             ymin = 16, ymax = 20, fill = colours_5[[1]],
             alpha = common_alpha
    ) +
    geom_split_violin(aes(x=age %>% as.factor(),  y=G3, fill=gender),
                      draw_quantiles = c(0.5)) +
    scale_fill_manual(values=alpha(matlab.colors[2:1], 0.8)) +
    theme_bw() +
    annotate("text", x = "22", y = 5,  label = "F-students\n area") +
    annotate("text", x = "22", y = 11, label = "D-students\n area") +
    annotate("text", x = "22", y = 13, label = "C-students\n area") +
    annotate("text", x = "22", y = 15, label = "B-students\n area") +
    annotate("text", x = "22", y = 18, label = "A-students\n area") +
    labs(x = "Age",
         y = "Final grade",
         title = "Comparison males and females' grades against age")
  
}
```

Result: the majority of students are in C and D areas, besides there is no difference
between males and females, but after the age of 18 the distribution is completely different 
and we do not have a solid explanation for that.
